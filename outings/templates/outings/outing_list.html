{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load l10n %}

{% block css %}
<!-- flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Choices -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
{% endblock %}

{% block title %}{% trans "Outings" %} | {{ block.super }}{% endblock %}

{% block leftsidebar %}
    <div class="wrap-collabsible mb-4">
        <input id="collapsible" class="toggle" type="checkbox">
        <label for="collapsible" class="label-toggle">{% trans 'Filters' %}</label>
        <div class="collapsible-content">
            <div class="content-inner">
                <form id="outing-form" method="get" action="{% url 'outings:list' %}">
                    <div class="form-row">
                        <div class="form-group col-12">
                            <h6 class="filter_title">{% trans 'Keywords' %}</h6>
                            <input class="form-control" type="search" placeholder="{% trans 'Keywords...' %}" aria-label="Search" value="{% if keywords %}{{ keywords }}{% endif %}" name="k">
                        </div>
                        <div class="form-group col-12">
                            <h6 class="filter_title">{% trans 'Dates' %}</h6>
                            <div class="form-row">
                                <div class="form-group col-6 col-xl-12 mb-0">
                                    <h6 class="mb-1 text-secondary filter_subtitle">{% trans 'From' %}</h6>
                                    <div class="input-group mb-2">
                                        <input type="text" name="outing_start_date" class="form-control" id="id_outing_start_date"{% if outing_start_date %} value={{ outing_start_date }}{% endif %}>
                                        <div id="id_outing_start_date_clear_container" class="input-group-append">
                                            <button id="id_outing_start_date_clear" type="button" class="btn btn-danger btn-clear-date" title="Clear">X</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group col-6 col-xl-12 mb-0">
                                    <h6 class="mb-1 text-secondary filter_subtitle">{% trans 'Till' %}</h6>
                                    <div class="input-group">
                                        <input type="text" name="outing_end_date" class="form-control" id="id_outing_end_date"{% if outing_end_date %} value={{ outing_end_date }}{% endif %}>
                                        <div id="id_outing_end_date_clear_container" class="input-group-append">
                                            <button id="id_outing_end_date_clear" type="button" class="btn btn-danger btn-clear-date" title="Clear">X</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-12">
                            <h6 class="filter_title">{% trans 'Activities' %}</h6>
                            <ul id="id_activities" class="selectable-items-list">
                                {% for activity in all_activities %}
                                <li><input type="checkbox" name="a" value="{{ activity }}" class="" id="id_activities_{{ activity|cut:' ' }}" {% if activity.name in selected_activities %}checked{% endif %}><label for="id_activities_{{ activity|cut:' ' }}" class="px-2 mb-1"><small>{{ activity.name }}</small></label></li>
                                {% endfor %}
                            </ul>
<!--                             <select multiple class="form-control" name="a" id="activities_filter">
                                <option value="">{% trans 'Click to select activities' %}</option>
                                {% for activity in all_activities %}
                                    <option {% if activity.name in selected_activities %}selected{% endif %}>{{ activity.name }}</option>
                                {% endfor %}
                            </select> -->
                        </div>
                        <div class="form-group col-12">
                            <button class="btn btn-outline-success btn-block" type="submit">{% trans "Filter" %}</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block rightsidebar %}
    <div class="text-center d-none d-xl-block">
        <a href="{% url 'outings:create' %}" class="btn btn-success">{% trans "Add an outing" %}</a>
    </div>
{% endblock %}


{% block content %}
    <div class="alert alert-info" role="alert">
        <strong>{% trans "You didn't find any outing that fits your availabilities?" %}</strong> <a href="{% url 'profiles:list' %}?start_date={% if outing_start_date %}{{ outing_start_date }}{% endif %}&end_date={% if outing_end_date %}{{ outing_end_date }}{% endif %}{% if selected_activities %}{% for a in selected_activities %}&a={{ a }}{% endfor %}{% endif %}">{% trans "Check the profiles page" %}</a>{% trans ": maybe some profiles have filled out their availabilities in their calendar. Meaning they intend to go out but don't know what to do exactly and are opened to suggestions." %}
    </div>
    {% if outing_list %}
        <p>
            {% blocktrans count counter=nb_of_results %}
            {{ counter }} outing
            {% plural %}
            {{ counter }} outings
            {% endblocktrans %}
        </p>
        <ul class="row list-unstyled">
            {% for outing in outing_list %}
                <li class="col-sm-6 col-md-4 mb-4">
                    <div class="card" onclick="document.location='{{ outing.get_absolute_url }}'" style="cursor: pointer;">
                        <div class="card-body">
                            <h5 class="card-title"><a href="{{ outing.get_absolute_url }}" class="unstyled">{{ outing.title }}</a></h5>
                            <p class="card-text">
                                {% blocktrans with start_date=outing.start_date|date:"SHORT_DATE_FORMAT" end_date=outing.end_date|date:"SHORT_DATE_FORMAT" count duration=outing.duration %}
                                During the day<br>{{ start_date }}
                                {% plural %}
                                {{ duration }} days<br>{{ start_date }} - {{ end_date }}
                                {% endblocktrans %}
                                <br>
                                {% for activity in outing.activities.all %}
                                    <span class="badge badge-pill badge-info">{{ activity.name }}</span>
                                {% endfor %}
                            </p>
                        </div>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>{% trans 'There is no outing fitting your search criteria.' %}</p>
    {% endif %}
    <a href="{% url 'outings:create' %}" class="btn btn-success btn-circle btn-add d-block d-xl-none"  style="z-index:9999"></a>
{% endblock %}

{% block js %}
<!-- Choices -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
    let activitiesChoicesElt = document.getElementById('activities_filter');
    const activitiesChoices = new Choices(activitiesChoicesElt, {
        removeItemButton: true,
        itemSelectText: '',
        noChoicesText: '',
    });
</script>
<!-- flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/it.js"></script>
<script>
    let outingStartDateCalendar = flatpickr("#id_outing_start_date", {
        locale: "{{ LANGUAGE_CODE }}",
        altInput: true,
        altFormat: "j F Y",
        dateFormat: "Y-m-d",
        minDate: "today",
    });
    let outingEndDateCalendar = flatpickr("#id_outing_end_date", {
        locale: "{{ LANGUAGE_CODE }}",
        altInput: true,
        altFormat: "j F Y",
        dateFormat: "Y-m-d",
        minDate: "today",
    });

    let outingStartDateClearElt = document.getElementById('id_outing_start_date_clear');
    let outingEndDateClearElt = document.getElementById('id_outing_end_date_clear');
    outingStartDateClearElt.addEventListener("click", function() {
        outingStartDateCalendar.clear();
    });
    outingEndDateClearElt.addEventListener("click", function() {
        outingEndDateCalendar.clear();
    });

    function isMobileDevice() {
        return ;
    };

    // HIDE THE DELETE BUTTON IF THE WEBSITE IS DISPLAYED ON A SMARTPHONE
    let isMobile = navigator.userAgent.match(/(iPhone|iPod|iPad|Android|webOS|BlackBerry|IEMobile|Opera Mini)/i)
    let outingStartDateClearContainerElt = document.getElementById('id_outing_start_date_clear_container');
    if (isMobile) {
        outingStartDateClearContainerElt.style.display = "none";
    }
    let outingEndDateClearContainerElt = document.getElementById('id_outing_end_date_clear_container');
    if (isMobile) {
        outingEndDateClearContainerElt.style.display = "none";
    }
</script>
<!-- Dates form validation -->
<script>
// NOTIFY START DATE > END DATE TO THE INTERNAUT WHEN HE MAKE THE MISTAKE
    const outingStartDateElt = document.getElementById('id_outing_start_date');
    const outingEndDateElt = document.getElementById('id_outing_end_date');

    let outingStartDate = outingStartDateElt.value;
    let outingEndDate = outingEndDateElt.value;

    function checkDatesCompatibility(startDate, endDate) {
        if (startDate <= endDate || endDate === "") {
            const errorListElt = document.getElementById("date_errors");
            if (errorListElt) {
                errorListElt.parentNode.removeChild(errorListElt);
            }
        } else {
            const errorListElt = document.getElementById("date_errors");
            if ( errorListElt === null ) {
                datesFormElt = outingEndDateElt.parentNode.parentNode;
                const errorListElt = document.createElement("ul");
                errorListElt.id = "date_errors";
                errorListElt.classList.add("errorlist");
                datesFormElt.appendChild(errorListElt);
                const errorItemElt = document.createElement("li");
                errorItemElt.textContent = "Your end date is not equal or later than your start date.";
                errorListElt.appendChild(errorItemElt);
            }
        }
    }

    outingStartDateElt.addEventListener('change', function() {
        if (outingStartDateElt.value) {
            outingStartDate = new Date(outingStartDateElt.value);
        } else {
            outingStartDate = "";
        }
        checkDatesCompatibility(outingStartDate, outingEndDate);
    });

    outingEndDateElt.addEventListener('change', function() {
        if (outingEndDateElt.value) {
            outingEndDate = new Date(outingEndDateElt.value);
        } else {
            outingEndDate = "";
        }
        checkDatesCompatibility(outingStartDate, outingEndDate);
    });
</script>
{% endblock %}